{% extends 'layout.html' %}

{% block link %}
<script src="{{ url_for('static', filename='_js/recorderWorker.js') }}"></script>
<script src="{{ url_for('static', filename='_js/recorder.js') }}"></script>
<script src="{{ url_for('static', filename='_js/audiodisplay.js') }}"></script>
<script src="{{ url_for('static', filename='_js/main.js') }}"></script>
{% endblock %}

{% block body %}
<div class="container">
    <div class="col-xs-10">
        <div class="jumbotron" style="background-color: #f9f9f9">
            <!-- DIV 1: desription -->
            <div id="instruction-div" style="text-align: justify">
                <h3 style="text-align: center;">Describing images out loud</h3>
                <br>
                <p>
                    Recent research has shown that someone's voice might contain information
                    with regard to how they are feeling. In the current study, we want to
                    further develop these methods by recording a small segment of speech
                    of you describing an image out loud. These recordings will be securely
                    stored and analyzed automatically by a computer so no human will listen
                    to them. This task takes a total of 5 minutes. First, we will test
                    whether your microphone works correctly. Your browser will prompt you to give
                    microphone access.
                    <hr>
                    <br>
                <div style="text-align: center">
                    <button id="validate-btn" class="btn btn-primary" onclick="validate_audio()">Continue to microphone
                        check</button>
                </div>
            </div>
            <!-- DIV 2: audio quality check -->
            <div id="audio-check-div" style="text-align: center;" hidden>
                <div style="display: inline-block; text-align: left;">
                    <h3 style="text-align: center;">Validate your audio quality:</h3>
                    <br>
                    <p style="text-align: justify;">
                        Click the “Start” button to start a recording, and press “Stop” to
                        finish. Use the “Play” button to listen to your recording. If the
                        recording works, you can continue to the task.<br><br>
                        During the task, you will see an image which we would like you
                        to describe out loud. The image appears when you click the green
                        “Start” button. You can click “Stop” when you are finished to
                        stop the recording. Please describe the image in detail, what
                        you see, what you feel, whatever comes to mind. There is no right
                        or wrong response, but try to speak for at least 30 seconds.
                        You will see a total of 2 images, after that the task if
                        finished and your data is saved.
                    </p>
                </div>
                <div class="container">
                    <div style="text-align: center">
                        <button id="check-start-btn" class="btn btn-success"
                            onclick="wrap_start_recording_check()">Start
                        </button>
                        <button id="check-stop-btn" class="btn btn-danger" style="margin-left: 20px"
                            onclick="stop_send_recording_check()" disabled>Stop
                        </button>
                        <button id="check-play-btn" class="btn btn-info" style="margin-left: 20px" onclick="play()"
                            disabled>Play
                        </button>
                    </div>
                </div>
                <br>
                <canvas id="analyser" style="width:100%;height:150px;background-color: whitesmoke" width="1024"
                    height="500"></canvas>
                <textarea id="output" style="width: 100%;height: 100px" readonly hidden></textarea>
                <hr>
                <br>
                <div style="text-align: center;">
                    <button id="images-btn" class="btn btn-primary" onclick="show_first_img_div()" disabled>
                        Continue to image description
                    </button>
                </div>
            </div>
            <!-- DIV 3: Photo paths -->
            <div id="img0-div" hidden>
                <img id="img0" src="{{ url_for('static', filename=photo_paths[0]) }}" alt="{{ photo_paths }}"
                    style="max-height: 100%; opacity: 0;" />
                <br>
                <hr>
                <div id="startstopbtndiv" class="container-fluid" style="text-align: center">
                    <p id="start0text">Press "Start" to display image and start describing</p>
                    <p id="stop0text" hidden>
                        If you cannot click "Continue" yet, it means your data is still
                        loading, this can take a few seconds.
                    </p>
                    <button id="start-img0-btn" class="btn btn-success" onclick="wrap_start_recording(0)">Start</button>
                    <button id="stop-img0-btn" class="btn btn-danger" style="margin-left: 20px"
                        onclick="stop_send_recording(0)" disabled>Stop
                    </button>
                </div>
                <br>
                <div id="gonext0" style="text-align: center">
                    <button id="next0-btn" class="btn btn-primary" value="next" onclick="show_second_img()"
                        disabled>Continue
                    </button>
                </div>
            </div>
            <div id="img1-div" hidden>
                <img id="img1" src="{{ url_for('static', filename=photo_paths[1]) }}" alt="{{ photo_paths }}"
                    style="max-height: 100%; opacity: 0;" />
                <br>
                <hr>
                <div id="startstopbtndiv" class="container-fluid" style="text-align: center">
                    <p id="start1text">Press "Start" to display image and start describing</p>
                    <p id="stop1text" hidden>
                        If you cannot click "Finish" yet, it means your data is still
                        loading, this can take a few seconds.
                    </p>
                    <button id="start-img1-btn" class="btn btn-success" onclick="wrap_start_recording(1)">Start</button>
                    <button id="stop-img1-btn" class="btn btn-danger" style="margin-left: 20px"
                        onclick="stop_send_recording(1)" disabled>Stop
                    </button>
                </div>
                <br>
                <div id="gonext1" style="text-align: center">
                    <button id="next1-btn" class="btn btn-primary" value="next" onclick="thank_you()" disabled>Finish
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# This shouldnt be here but it works, so let's keep it here for now #}
    <script>
        var au = undefined;

        // Override gotBuffers in main.js to play-back audio
        function gotBuffers(buffers) {
            console.log("gotBuffers v1");
            audioRecorder.exportMonoWAV(createDownloadLink);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ----------------- Audio quality check -----------------
        function validate_audio() {
            document.getElementById("validate-btn").disabled = true;
            document.getElementById("instruction-div").hidden = true;
            initAudio();
            document.getElementById("audio-check-div").hidden = false;
        }

        function wrap_start_recording_check() {
            document.getElementById('check-start-btn').disabled = true;
            document.getElementById('check-stop-btn').removeAttribute('disabled');
            startRecording();
        }

        function stop_send_recording_check() {
            stopRecording();
            document.getElementById('check-stop-btn').disabled = true;
            document.getElementById('check-start-btn').disabled = false;
            document.getElementById('check-play-btn').disabled = false;
            document.getElementById('images-btn').disabled = false;
        }

        function play() {
            if (au.paused) {
                au.play();
            }
        }

        // load first image
        function show_first_img_div() {
            // note -> we override again the `gotBuffers` function to ensure that 
            // the speech samples will be uploaded
            gotBuffers = function (buffers, file_id) {
                console.log("gotBuffers v2");
                audioRecorder.exportWAV(doneEncoding);
            };
            document.getElementById('audio-check-div').hidden = true;
            document.getElementById('img0-div').hidden = false;
        }

        // ----------------- Image description -----------------
        function wrap_start_recording(index) {
            startRecording();
            document.getElementById('start-img' + index + '-btn').disabled = true;
            document.getElementById('stop-img' + index + '-btn').removeAttribute('disabled');
            document.getElementById('img' + index).style.opacity = "1.0";
        }

        async function stop_send_recording(index) {
            img_id = "img" + index;
            btn_next_id = "next" + index + "-btn";
            document.getElementById('stop-img' + index + '-btn').disabled = true;
            document.getElementById("start" + index + "text").hidden = true;
            document.getElementById("stop" + index + "text").hidden = false;
            await sleep(50);
            await stopRecording();
            await sleep(100);
        }

        // show second img
        function show_second_img() {
            document.getElementById('img0-div').hidden = true;
            document.getElementById('img1-div').hidden = false;
        }

        function thank_you() {
            var root = location.protocol + '//' + location.host;
            window.location.href = root + '/thank_you';
        }

        function createDownloadLink(blob) {
            var url = window.URL.createObjectURL(blob);
            au = document.createElement('audio');

            //add controls to the <audio> element
            au.controls = false;
            au.autoplay = true
            au.src = url;

            //add the new audio element to
            document.body.appendChild(au)
        }
    </script>
</div>
{% endblock %}