{% extends 'layout.html' %}

{% block link %}
<script src="{{ url_for('static', filename='_js/recorderWorker.js') }}"></script>
<script src="{{ url_for('static', filename='_js/recorder.js') }}"></script>
<script src="{{ url_for('static', filename='_js/audiodisplay.js') }}"></script>
<script src="{{ url_for('static', filename='_js/main.js') }}"></script>
{% endblock %}

{% block body %}
<div class="container">
    <div class="col-xs-10">
        <div class="jumbotron" style="background-color: #f9f9f9">
            <!-- DIV 1: desription -->
            <div id="instruction-div" style="text-align: justify">
                <h3 style="text-align: center;">Describing Images Out Loud</h3>
                <br>
                <p>
                    Recent research has shown that a person’s voice may contain information
                    about how they feel. In this study, we want to test this possibility
                    by recording a short speech clip while you describe two images out
                    loud. These recordings will be analyzed automatically by a computer
                    and no human will ever listen to them. This will take approximately 5
                    minutes.
                    <br><br>
                    First, let’s make sure your microphone works correctly. Your web browser
                    will ask you for microphone access only for this website. Click below
                    to continue with the test.
                    <hr>
                    <br>
                <div style="text-align: center">
                    <button id="validate-btn" class="btn btn-primary" onclick="validate_audio()">Continue to microphone
                        check</button>
                </div>
            </div>
            <!-- DIV 2: audio quality check -->
            <div id="audio-check-div" style="text-align: center;" hidden>
                <div style="display: inline-block; text-align: left;">
                    <h3 style="text-align: center;">Check Your Audio</h3>
                    <br>
                    <p style="text-align: justify;">
                        Click the “Start” button to start a recording and press “Stop”
                        to finish recording. Then, use the “Play” button to listen to
                        your recording. If the recording works, click below to continue.
                    </p>
                </div>
                <div class="container">
                    <div style="text-align: center">
                        <button id="check-start-btn" class="btn btn-success"
                            onclick="wrap_start_recording_check()">Start
                        </button>
                        <button id="check-stop-btn" class="btn btn-danger" style="margin-left: 20px"
                            onclick="stop_send_recording_check()" disabled>Stop
                        </button>
                        <button id="check-play-btn" class="btn btn-info" style="margin-left: 20px" onclick="play()"
                            disabled>Play
                        </button>
                    </div>
                </div>
                <br>
                <canvas id="analyser" style="width:100%;height:150px;background-color: whitesmoke" width="1024"
                    height="500"></canvas>
                <textarea id="output" style="width: 100%;height: 100px" readonly hidden></textarea>
                <hr>
                <br>
                <div style="text-align: center;">
                    <button id="instruction-btn" class="btn btn-primary" onclick="show_instruction_div()" disabled>
                        Continue to instructions
                    </button>
                </div>
            </div>
            <!-- DIV 3: image description instructions -->
            <div id="img-instruction-div" hidden>
                <h3 style="text-align: center;">Image Description Instructions</h3>
                <br>
                <p style="text-align: justify;">
                    On the next page, you will see an image that we would like you to
                    describe out loud. The image will appear when you click the green
                    “Start” button. When you are finished describing the image, click “Stop”.
                    <br><br>
                    Please describe the image in detail, focusing on what you see, what
                    you feel, and whatever else comes to mind. There is no right or
                    wrong response, but please speak for at least 30 seconds about the image.
                    <br><br>
                    You will then click Continue to see a second image. After that,
                    you are finished!
                </p>
                <hr>
                <br>
                <div style="text-align: center;">
                    <button id="images-btn" class="btn btn-primary" onclick="show_first_img_div()">
                        Continue to image description
                    </button>
                </div>
            </div>
            <!-- DIV 4: photo descriptions -->
            <div id="img0-div" hidden>
                <img id="img0" src="{{ url_for('static', filename=photo_paths[0]) }}" alt="{{ photo_paths }}"
                    style="max-height: 100%; opacity: 0;" />
                <br>
                <hr>
                <div id="startstopbtndiv" class="container-fluid" style="text-align: center">
                    <p id="stop0text" hidden>
                        Your data is loading, the next screen will appear when it is
                        finished. This can take a few seconds.
                    </p>
                    <button id="start-img0-btn" class="btn btn-success" style="text-align: center;"
                        onclick="wrap_start_recording(0)">
                        Click here to show the 1st image & start describing for 30 seconds</button><br><br>
                    <button id="stop-img0-btn" class="btn btn-danger" style="text-align: center;"
                        onclick="stop_send_recording(0)" disabled>
                        After describing the image for 30 seconds, click here to stop
                    </button>
                </div>
            </div>
            <div id="img1-div" hidden>
                <img id="img1" src="{{ url_for('static', filename=photo_paths[1]) }}" alt="{{ photo_paths }}"
                    style="max-height: 100%; opacity: 0;" />
                <br>
                <hr>
                <div id="startstopbtndiv" class="container-fluid" style="text-align: center">
                    <p id="stop1text" hidden>
                        Your data is loading, the next screen will appear when it is
                        finished. This can take a few seconds.
                    </p>
                    <button id="start-img1-btn" class="btn btn-success" style="text-align: center;"
                        onclick="wrap_start_recording(1)">
                        Click here to show the 2nd image & start describing for 30 seconds</button><br><br>
                    <button id="stop-img1-btn" class="btn btn-danger" style="text-align: center;"
                        onclick="stop_send_recording(1)" disabled>
                        After describing the image for 30 seconds, click here to stop
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# This shouldn't be here but it works, so let's keep it here for now #}
    <script>
        btn_next_id = 'instruction-btn';
        var au = undefined;

        // Override gotBuffers in main.js to play-back audio
        function gotBuffers(buffers) {
            console.log("gotBuffers v1");
            audioRecorder.exportMonoWAV(createDownloadLink);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ----------------- Audio quality check -----------------
        function validate_audio() {
            document.getElementById("validate-btn").disabled = true;
            document.getElementById("instruction-div").hidden = true;
            initAudio();
            document.getElementById("audio-check-div").hidden = false;
        }

        function wrap_start_recording_check() {
            document.getElementById('check-start-btn').disabled = true;
            document.getElementById('check-stop-btn').removeAttribute('disabled');
            startRecording();
        }

        function stop_send_recording_check() {
            stopRecording();
            document.getElementById('check-stop-btn').disabled = true;
            document.getElementById('check-start-btn').disabled = false;
            document.getElementById('check-play-btn').disabled = false;
            document.getElementById('instruction-btn').disabled = false;
        }

        function play() {
            if (au.paused) {
                au.play();
            }
        }

        // ----------------- Image description instructions -----------------
        function show_instruction_div() {
            document.getElementById("audio-check-div").hidden = true;
            document.getElementById("img-instruction-div").hidden = false;
        }

        // load first image
        function show_first_img_div() {
            // note -> we override again the `gotBuffers` function to ensure that 
            // the speech samples will be uploaded
            gotBuffers = function (buffers, file_id) {
                console.log("gotBuffers v2");
                audioRecorder.exportWAV(doneEncoding);
            };
            document.getElementById('img-instruction-div').hidden = true;
            document.getElementById('img0-div').hidden = false;
        }

        // ----------------- Image description -----------------
        function wrap_start_recording(index) {
            startRecording();
            document.getElementById('start-img' + index + '-btn').disabled = true;
            document.getElementById('stop-img' + index + '-btn').removeAttribute('disabled');
            document.getElementById('img' + index).style.opacity = "1.0";
        }

        async function stop_send_recording(index) {
            img_id = "img" + index;
            document.getElementById('stop-img' + index + '-btn').disabled = true;
            // document.getElementById("start" + index + "text").hidden = true;
            document.getElementById("stop" + index + "text").hidden = false;
            await sleep(50);
            await stopRecording();
            await sleep(200);
            document.getElementById('img' + index + '-div').hidden = true;
            if (index < 1) {
                document.getElementById('img' + (index + 1) + '-div').hidden = false;
            }
            else {
                thank_you();
            }
        }

        function thank_you() {
            var root = location.protocol + '//' + location.host;
            window.location.href = root + '/thank_you';
        }

        function createDownloadLink(blob) {
            var url = window.URL.createObjectURL(blob);
            au = document.createElement('audio');

            //add controls to the <audio> element
            au.controls = false;
            au.autoplay = true
            au.src = url;

            //add the new audio element to
            document.body.appendChild(au)
        }
    </script>
</div>
{% endblock %}